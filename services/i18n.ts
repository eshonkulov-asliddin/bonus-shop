import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';

export type Lang = 'uz' | 'en' | 'ru';

type Dict = Record<string, string>;

type Translations = Record<Lang, Dict>;

const translations: Translations = {
  uz: {
    appName: 'Bonus',
    appTagline: "Mahalliy Do'konlar Tarmog'i",
    loading: 'Yuklanmoqda...',
    close: 'Yopish',
    showToSeller: "Sotuvchiga Ko'rsating",
    lockSession: 'Sessiyani qulflash',
    refresh: 'Yangilash',
    merchantAccess: 'Sotuvchi Kirishi',
    terminalHub: 'Terminal markazi',
    terminalIq: 'Terminal IQ',
    systemReady: 'Tizim birinchi skan uchun tayyor.',
    registeredMembers: 'Ro‘yxatdan o‘tgan aʼzolar',
    totalShopVolume: 'Umumiy do‘kon hajmi',
    adminLogin: 'Admin Kirish',
    userLogin: 'Mijoz Kirishi',
    telegramPrompt: 'Cashback mukofotlaringizga kirish uchun Telegram orqali kiring',
    backToUserLogin: '← Foydalanuvchi Kirishiga Qaytish',
    usernameLabel: 'Foydalanuvchi',
    usernamePlaceholder: 'Admin foydalanuvchi nomi',
    passwordLabel: 'Parol',
    passwordPlaceholder: 'Parol kiriting',
    signInLoading: 'Kirish...',
    giveReward: '1. Mukofot bering',
    useBalance: '2. Balansdan foydalaning',
    tapToScan: 'Skan qilish uchun bosing',
    orSelectUser: 'yoki ro\'yxatdan tanlang',
    searchUser: 'Mijozni qidiring...',
    quickSelect: 'Tez tanlash',
    totalBillPrice: 'Umumiy hisob narxi',
    priceToDeduct: 'Ayriladigan summa',
    newBalancePrediction: 'Yangi balans bashorati',
    transactionImpact: 'Tranzaksiya taʼsiri',
    cancel: 'Bekor qilish',
    latestTransactions: 'So‘nggi tranzaksiyalar',
    customer: 'Mijoz',
    type: 'Turi',
    adjustment: 'O‘zgarish',
    time: 'Vaqt',
    userCashbackOverview: 'Foydalanuvchi Cashback Ko‘rinishi',
    earned: 'Yig‘ilgan',
    used: 'Ishlatildi',
    activeProtection: 'Faol himoya',
    encryptedSessions: 'Shifrlangan sessiyalar',
    currentBalance: 'Joriy balans',
    reward: 'Mukofot',
    rewardPlus: 'Mukofot +',
    deductMinus: 'Ayrish -',
    loginMissing: 'Iltimos, foydalanuvchi va parol kiriting',
    invalidCredentials: "Foydalanuvchi yoki parol noto'g'ri",
    connectionError: "Ulanishda xatolik. Iltimos, qaytadan urinib ko'ring.",
    myAccount: 'Mening Hisobim',
    memberCard: "Raqamli Aʼzolik Karta",
    availableRewards: 'Mavjud Mukofotlar',
    payOrReward: "To'lov yoki Mukofot",
    recentActivity: 'Oxirgi Faoliyat',
    viewAll: 'Hammasini ko\'rish',
    showLess: 'Kamroq ko\'rsatish',
    total: 'Jami',
    noActivity: "Hali faoliyat yo'q.",
    status: 'Holat',
    tierBronze: 'Bronza',
    tierSilver: 'Kumush',
    tierGold: 'Oltin',
    customerId: 'Mijoz ID',
    invalidRedeem: 'Xato: Mijozning Balansi Yetarli Emas',
    processing: 'Qayta Ishlanmoqda...',
    deletedUser: "O'chirilgan Foydalanuvchi",
    noPhone: "Telefon yo'q",
    noUsersAlert: 'Bazadan foydalanuvchilar topilmadi. Iltimos, Google Sheets ulanishini tekshiring.',
    unknownUserQR: 'Nomaʼlum foydalanuvchi QR',
    failedSaveTransaction: "Tranzaksiyani saqlash muvaffaqiyatsiz. Iltimos, yana urinib ko'ring.",
    failedProcessTransaction: "Tranzaksiyani bajarish muvaffaqiyatsiz. Iltimos, yana urinib ko'ring.",
    connectionErrorRetrying: 'Ulanish xatosi. Qayta urinish...',
    giveRewardHint: 'Xarid uchun mukofot bering. Tizim 1% bonus hisoblaydi.',
    useBalanceHint: "Mavjud ballarni hisobni to'lash uchun ishlating.",
    showAll: "Hammasini ko'rish",
    showLess: "Kamroq ko'rish",
    downloadQR: 'QR yuklab olish',
    totalUsers: 'Jami mijozlar',
    totalTransactions: 'Jami tranzaksiyalar',
    todayTransactions: 'Bugungi tranzaksiyalar',
    todayVolume: 'Bugungi hajm',
    avgPerUser: "O'rtacha (har bir mijoz)",
    viewStatistics: 'Statistikani ko\'rish',
    today: 'bugun'
  },
  en: {
    appName: 'Bonus',
    appTagline: 'Local Shops Network',
    loading: 'Loading...',
    close: 'Close',
    showToSeller: 'Show to Seller',
    lockSession: 'Lock Session',
    refresh: 'Refresh',
    merchantAccess: 'Merchant Access',
    terminalHub: 'Terminal Hub',
    terminalIq: 'Terminal IQ',
    systemReady: 'System ready for first scan.',
    registeredMembers: 'Registered Members',
    totalShopVolume: 'Total Shop Volume',
    adminLogin: 'Admin Login',
    userLogin: 'Customer Login',
    telegramPrompt: 'Sign in with Telegram to access cashback rewards',
    backToUserLogin: '← Back to Customer Login',
    usernameLabel: 'Username',
    usernamePlaceholder: 'Admin username',
    passwordLabel: 'Password',
    passwordPlaceholder: 'Enter password',
    signInLoading: 'Signing in...',
    giveReward: '1. Give Reward',
    useBalance: '2. Use Balance',
    tapToScan: 'Tap to Scan',
    orSelectUser: 'or select from list',
    searchUser: 'Search customer...',
    quickSelect: 'Quick Select',
    totalBillPrice: 'Total Bill Price',
    priceToDeduct: 'Price to Deduct',
    newBalancePrediction: 'New Balance Prediction',
    transactionImpact: 'Transaction Impact',
    cancel: 'Cancel',
    latestTransactions: 'Latest Transactions',
    customer: 'Customer',
    type: 'Type',
    adjustment: 'Adjustment',
    time: 'Time',
    userCashbackOverview: 'User Cashback Overview',
    earned: 'Earned',
    used: 'Used',
    activeProtection: 'Active Protection',
    encryptedSessions: 'Encrypted Sessions',
    currentBalance: 'Current Balance',
    reward: 'Reward',
    rewardPlus: 'Reward +',
    deductMinus: 'Deduct -',
    loginMissing: 'Please enter username and password',
    invalidCredentials: 'Invalid username or password',
    connectionError: 'Connection error. Please try again.',
    myAccount: 'My Account',
    memberCard: 'Digital Member Card',
    availableRewards: 'Available Rewards',
    payOrReward: 'Pay or Reward',
    recentActivity: 'Recent Activity',
    viewAll: 'View All',
    showLess: 'Show Less',
    total: 'Total',
    noActivity: 'No activity yet.',
    status: 'Status',
    tierBronze: 'Bronze',
    tierSilver: 'Silver',
    tierGold: 'Gold',
    customerId: 'Customer ID',
    invalidRedeem: 'Error: Insufficient customer balance',
    processing: 'Processing...',
    deletedUser: 'Deleted User',
    noPhone: 'No phone',
    noUsersAlert: 'No users found in database. Please check Google Sheets connection.',
    unknownUserQR: 'Unknown User QR',
    failedSaveTransaction: 'Failed to save transaction. Please try again.',
    failedProcessTransaction: 'Failed to process transaction. Please try again.',
    connectionErrorRetrying: 'Connection error. Retrying...',
    giveRewardHint: 'Reward a purchase. System calculates 1% bonus.',
    useBalanceHint: 'Redeem existing points to pay for a bill.',
    showAll: 'Show All',
    showLess: 'Show Less',
    downloadQR: 'Download QR',
    totalUsers: 'Total Customers',
    totalTransactions: 'Total Transactions',
    todayTransactions: 'Today\'s Transactions',
    todayVolume: 'Today\'s Volume',
    avgPerUser: 'Avg per Customer',
    viewStatistics: 'View Statistics',
    today: 'today'
  },
  ru: {
    appName: 'Бонус',
    appTagline: 'Сеть местных магазинов',
    loading: 'Загрузка...',
    close: 'Закрыть',
    showToSeller: 'Покажите продавцу',
    lockSession: 'Заблокировать сессию',    refresh: 'Обновить',    merchantAccess: 'Доступ продавца',
    terminalHub: 'Центр терминала',
    terminalIq: 'Терминал IQ',
    systemReady: 'Система готова к первому сканированию.',
    registeredMembers: 'Зарегистрированные участники',
    totalShopVolume: 'Общий объем магазина',
    adminLogin: 'Вход для админа',
    userLogin: 'Вход клиента',
    telegramPrompt: 'Войдите через Telegram, чтобы получить доступ к кешбэку',
    backToUserLogin: '← Назад к входу клиента',
    usernameLabel: 'Имя пользователя',
    usernamePlaceholder: 'Имя админа',
    passwordLabel: 'Пароль',
    passwordPlaceholder: 'Введите пароль',
    signInLoading: 'Вход...',
    giveReward: '1. Выдать бонус',
    useBalance: '2. Использовать баланс',
    tapToScan: 'Нажмите для сканирования',
    orSelectUser: 'или выберите из списка',
    searchUser: 'Поиск клиента...',
    quickSelect: 'Быстрый выбор',
    totalBillPrice: 'Итоговая сумма счета',
    priceToDeduct: 'Сумма к списанию',
    newBalancePrediction: 'Прогноз нового баланса',
    transactionImpact: 'Влияние транзакции',
    cancel: 'Отмена',
    latestTransactions: 'Последние транзакции',
    customer: 'Клиент',
    type: 'Тип',
    adjustment: 'Изменение',
    time: 'Время',
    userCashbackOverview: 'Обзор кешбэка пользователя',
    earned: 'Заработано',
    used: 'Использовано',
    activeProtection: 'Активная защита',
    encryptedSessions: 'Зашифрованные сессии',
    currentBalance: 'Текущий баланс',
    reward: 'Бонус',
    rewardPlus: 'Бонус +',
    deductMinus: 'Списание -',
    loginMissing: 'Пожалуйста, введите имя пользователя и пароль',
    invalidCredentials: 'Неверное имя пользователя или пароль',
    connectionError: 'Ошибка соединения. Попробуйте ещё раз.',
    myAccount: 'Мой аккаунт',
    memberCard: 'Цифровая карта участника',
    availableRewards: 'Доступные бонусы',
    payOrReward: 'Оплата или бонус',
    recentActivity: 'Последняя активность',
    viewAll: 'Показать все',
    showLess: 'Показать меньше',
    total: 'Итого',
    noActivity: 'Активности пока нет.',
    status: 'Статус',
    tierBronze: 'Бронза',
    tierSilver: 'Серебро',
    tierGold: 'Золото',
    customerId: 'ID клиента',
    invalidRedeem: 'Ошибка: Недостаточно средств',
    processing: 'Обработка...',
    deletedUser: 'Удалённый пользователь',
    noPhone: 'Нет телефона',
    noUsersAlert: 'Пользователи не найдены. Проверьте подключение к Google Sheets.',
    unknownUserQR: 'Неизвестный QR пользователя',
    failedSaveTransaction: 'Не удалось сохранить транзакцию. Повторите попытку.',
    failedProcessTransaction: 'Не удалось выполнить транзакцию. Повторите попытку.',
    connectionErrorRetrying: 'Ошибка соединения. Повтор...',
    giveRewardHint: 'Начислите бонус за покупку. Система считает 1% бонуса.',
    useBalanceHint: 'Списать накопленные баллы для оплаты счета.',
    showAll: 'Показать все',
    showLess: 'Показать меньше',
    downloadQR: 'Скачать QR',
    totalUsers: 'Всего клиентов',
    totalTransactions: 'Всего транзакций',
    todayTransactions: 'Транзакции за сегодня',
    todayVolume: 'Объем за сегодня',
    avgPerUser: 'Среднее на клиента',
    viewStatistics: 'Статистика',
    today: 'сегодня'
  }
};

const I18nContext = createContext<{ lang: Lang; setLang: (l: Lang) => void; t: (key: keyof Dict) => string }>({
  lang: 'uz',
  setLang: () => {},
  t: (key) => key,
});

export const I18nProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [lang, setLang] = useState<Lang>(() => {
    const saved = localStorage.getItem('lang') as Lang | null;
    if (saved) return saved;
    return 'uz';
  });

  useEffect(() => {
    localStorage.setItem('lang', lang);
  }, [lang]);

  const t = useMemo(() => {
    const dict = translations[lang];
    return (key: keyof Dict) => dict[key] ?? (translations['en'][key] ?? String(key));
  }, [lang]);

  const value = useMemo(() => ({ lang, setLang, t }), [lang]);

  return React.createElement(I18nContext.Provider, { value }, children);
};

export const useI18n = () => useContext(I18nContext);
